<div class="projects-container">
  <!-- Filters Section -->
  <div class="filters-section">
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Content Type</mat-label>
      <mat-select
        [(ngModel)]="contentTypeFilter"
        (selectionChange)="onContentTypeChange()"
      >
        @for (type of contentTypes; track type.value) {
        <mat-option [value]="type.value">{{ type.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search projects</mat-label>
      <input
        matInput
        [(ngModel)]="searchQuery"
        (input)="onSearchChange($event)"
        placeholder="Search by name..."
      />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <div class="sort-group">
      <mat-form-field appearance="outline" class="sort-field">
        <mat-label>Sort by</mat-label>
        <mat-select [(ngModel)]="sortBy" (selectionChange)="onSortChange()">
          @for (option of sortOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <button
        mat-icon-button
        (click)="onSortOrderToggle()"
        [matTooltip]="sortOrder === 'asc' ? 'Ascending' : 'Descending'"
        class="sort-order-button"
      >
        <mat-icon>{{
          sortOrder === "asc" ? "arrow_upward" : "arrow_downward"
        }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading projects...</p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !isLoading()) {
  <div class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error() }}</p>
    <button mat-raised-button color="primary" (click)="retryLoad()">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && !error() && projects().length === 0) {
  <mat-card class="empty-state">
    <mat-card-content>
      <mat-icon>folder_open</mat-icon>
      <h3>No projects found</h3>
      @if (searchQuery || contentTypeFilter) {
      <p>Try adjusting your filters or search terms</p>
      } @else {
      <p>Start by creating your first summarisation</p>
      }
    </mat-card-content>
  </mat-card>
  }

  <!-- Projects List -->
  @if (!isLoading() && projects().length > 0) {
  <div class="projects-list">
    <div class="projects-stacked-list">
      @for (project of projects(); track project.id) {
      <div
        class="project-list-item"
        [class.non-clickable]="!isProjectClickable(project)"
        [attr.aria-label]="getProjectAriaLabel(project)"
        [attr.tabindex]="isProjectClickable(project) ? 0 : -1"
        [attr.role]="'listitem'"
        (click)="onProjectClick($event, project)"
        (keydown.enter)="onProjectClick($event, project)"
        (keydown.space)="onProjectClick($event, project)"
      >
        <div class="project-main">
          <div
            class="project-avatar"
            *ngIf="getContentTypeMetadata(project.contentType) as meta"
            [style.--project-icon-color]="meta.iconColor"
            [style.--project-icon-bg]="meta.iconBackground"
            [attr.aria-hidden]="true"
          >
            <mat-icon [style.color]="meta.iconColor">{{ meta.icon }}</mat-icon>
          </div>

          <div
            class="project-content"
            [class.has-token]="shouldShowTokenBadge(project)"
          >
            <div class="project-header">
              <span class="project-name">{{ project.name }}</span>
            </div>

            <div class="project-meta">
              <span class="created-date">
                {{ formatRelativeTime(project.createdAt) }}
              </span>

              @if (shouldShowTokenBadge(project)) {
              <app-token-badge
                [tokensCount]="
                  project.status === 'processing'
                    ? project.tokensReserved || 0
                    : project.tokensUsed || 0
                "
                [isEstimation]="project.status === 'processing'"
                [tooltip]="
                  project.status === 'processing'
                    ? 'Estimated tokens reserved for processing'
                    : 'Tokens consumed'
                "
              >
              </app-token-badge>
              }

              @if (project.hasRewrite) {
              <app-rewrite-badge></app-rewrite-badge>
              }
            </div>

            <div class="project-badges mobile-only">
              @if (shouldShowTokenBadge(project)) {
              <app-token-badge
                [tokensCount]="
                  project.status === 'processing'
                    ? project.tokensReserved || 0
                    : project.tokensUsed || 0
                "
                [isEstimation]="project.status === 'processing'"
                [tooltip]="
                  project.status === 'processing'
                    ? 'Estimated tokens reserved for processing'
                    : 'Tokens consumed'
                "
              >
              </app-token-badge>
              }

              @if (project.hasRewrite) {
              <app-rewrite-badge></app-rewrite-badge>
              } @if (project.status) {
              <span
                class="status-badge"
                [ngClass]="getStatusBadgeClass(project)"
                [attr.aria-label]="getStatusAriaLabel(project)"
              >
                @if (isProcessing(project)) {
                <mat-icon inline class="spinning-icon">sync</mat-icon>
                } @if (project.status === 'completed') {
                <mat-icon inline>check_circle</mat-icon>
                } @if (project.status === 'failed') {
                <mat-icon inline>error</mat-icon>
                }
                <span class="status-text">{{
                  getStatusBadgeText(project)
                }}</span>
              </span>
              }
            </div>

            <div class="project-footer mobile-only">
              <span class="created-date">
                {{ formatRelativeTime(project.createdAt) }}
              </span>

              <button
                mat-icon-button
                class="delete-button mobile-only"
                [class.disabled]="!isProjectDeletable(project)"
                [disabled]="!isProjectDeletable(project)"
                [attr.aria-label]="getDeleteAriaLabel(project)"
                (click)="deleteProject($event, project)"
                (keydown.enter)="deleteProject($event, project)"
                (keydown.space)="deleteProject($event, project)"
                [matTooltip]="getDeleteTooltip(project)"
                color="warn"
              >
                <mat-icon [attr.aria-hidden]="true">delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <div class="project-actions">
          @if (project.status) {
          <span
            class="status-badge desktop-only"
            [ngClass]="getStatusBadgeClass(project)"
            [attr.aria-label]="getStatusAriaLabel(project)"
          >
            @if (isProcessing(project)) {
            <mat-icon inline class="spinning-icon">sync</mat-icon>
            } @if (project.status === 'completed') {
            <mat-icon inline>check_circle</mat-icon>
            } @if (project.status === 'failed') {
            <mat-icon inline>error</mat-icon>
            }
            <span class="status-text">{{ getStatusBadgeText(project) }}</span>
          </span>
          }

          <button
            mat-icon-button
            class="delete-button desktop-only"
            [class.disabled]="!isProjectDeletable(project)"
            [disabled]="!isProjectDeletable(project)"
            [attr.aria-label]="getDeleteAriaLabel(project)"
            (click)="deleteProject($event, project)"
            (keydown.enter)="deleteProject($event, project)"
            (keydown.space)="deleteProject($event, project)"
            [matTooltip]="getDeleteTooltip(project)"
            color="warn"
          >
            <mat-icon [attr.aria-hidden]="true">delete</mat-icon>
          </button>
        </div>
      </div>
      }
    </div>

    <!-- Load More Button -->
    @if (hasMore()) {
    <div class="load-more-container">
      @if (isLoadingMore()) {
      <mat-spinner diameter="30"></mat-spinner>
      } @else {
      <button
        mat-flat-button
        (click)="loadMore()"
        class="load-more-button enhanced"
      >
        <span class="button-text">Load More</span>
        <mat-icon class="button-icon">expand_more</mat-icon>
      </button>
      }
    </div>
    }

    <!-- Results Count -->
    <div class="results-info">
      Showing {{ projects().length }} of {{ totalProjects }} projects
    </div>
  </div>
  }
</div>
